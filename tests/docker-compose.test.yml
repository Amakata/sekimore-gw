version: "3.8"

# Docker Compose configuration for functional tests
# Use with: docker-compose -f docker-compose.test.yml up

networks:
  test-internal-net:
    driver: bridge
  test-internet:
    driver: bridge

services:
  sekimore-gw-test:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: sekimore-gw-test
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
      - SYS_ADMIN
    privileged: true
    sysctls:
      net.ipv4.ip_forward: "1"
      net.ipv4.conf.all.send_redirects: "0"
      net.ipv4.conf.default.send_redirects: "0"
    networks:
      test-internal-net: {}
      test-internet: {}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../config:/etc/sekimore:ro
      - test-gateway-data:/data
    environment:
      - PROJECT_NAME=sekimore-gw-test
      - INTERNAL_NETWORK_NAME=test-internal-net
      - INTERNET_NETWORK_NAME=test-internet
    ports:
      - "18080:8080"

  test-agent:
    image: python:3.11-slim
    container_name: test-agent
    cap_add:
      - NET_ADMIN
    networks:
      test-internal-net: {}
    dns:
      - 127.0.0.1
    dns_search: []
    volumes:
      - ../agent-setup.sh:/agent-setup.sh:ro
    command: ["/agent-setup.sh"]
    depends_on:
      - sekimore-gw-test

volumes:
  test-gateway-data:
    driver: local
